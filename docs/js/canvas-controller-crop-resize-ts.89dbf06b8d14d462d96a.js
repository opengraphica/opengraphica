"use strict";(self.webpackChunkOpenGraphica=self.webpackChunkOpenGraphica||[]).push([[9899],{12058:(t,e,i)=>{i.r(e),i.d(e,{default:()=>u});var n=i(84510),s=i(86617),a=i(91648),o=i(22053),r=i(67340),l=i(95452);class u extends n.default{remToPx=16;cropTranslateStart=null;cropStartDimensions={top:0,left:0,width:0,height:0};cropDragType=0;xAxisSnap=[];yAxisSnap=[];snapSensitivity=0;onEnter(){super.onEnter(),this.remToPx=parseFloat(getComputedStyle(document.documentElement).fontSize),s.eb.value=null,s.we.value=0,s.t$.value=0,s.bf.value=r.default.get("width"),s.Cb.value=r.default.get("height"),this.xAxisSnap=[0,Math.floor(s.bf.value/2),s.bf.value],this.yAxisSnap=[0,Math.floor(s.Cb.value/2),s.Cb.value],l.Z.emit("app.canvas.resetTransform",{margin:Math.floor(Math.min(window.innerWidth,window.innerHeight)/4)})}onMultiTouchDown(){super.onMultiTouchDown(),1===this.touches.length&&this.onCropDown()}onPointerDown(t){super.onPointerDown(t),t.isPrimary&&["mouse","pen"].includes(t.pointerType)&&0===t.button&&this.onCropDown()}onCropDown(){const t=window.devicePixelRatio||1,e=a.Z.get("transform"),i=a.Z.get("decomposedTransform"),n=new DOMPoint(this.lastCursorX*t,this.lastCursorY*t).matrixTransform(e.inverse());this.cropTranslateStart=n,this.cropStartDimensions={top:s.we.value,left:s.t$.value,width:s.bf.value,height:s.Cb.value},this.snapSensitivity=o.Z.get("snapSensitivity")/i.scaleX*t;let r=this.getCropDragType(n,i);null!=r?(this.cropDragType=r,s.G0.value=r):(this.cropTranslateStart=null,s.G0.value=null)}onPointerMove(t){if(super.onPointerMove(t),t.isPrimary&&this.cropTranslateStart){const t=window.devicePixelRatio||1,e=a.Z.get("transform"),i=new DOMPoint(this.lastCursorX*t,this.lastCursorY*t).matrixTransform(e.inverse()),n=0===this.cropDragType;let o=Math.floor(this.cropDragType/4)%2==1,r=Math.floor(this.cropDragType/8)%2==1,l=Math.floor(this.cropDragType/1)%2==1,u=Math.floor(this.cropDragType/2)%2==1;const h=Math.round(i.x-this.cropTranslateStart.x),p=Math.round(i.y-this.cropTranslateStart.y);let c=this.cropStartDimensions.width+h,v=this.cropStartDimensions.height+p;o&&(c=this.cropStartDimensions.width-h),l&&(v=this.cropStartDimensions.height-p);let f=this.cropStartDimensions.left,m=this.cropStartDimensions.top,D=this.cropStartDimensions.width,d=this.cropStartDimensions.height;if(n&&(m=this.cropStartDimensions.top+p,f=this.cropStartDimensions.left+h),l&&(m=this.cropStartDimensions.top-(v-this.cropStartDimensions.height)),o&&(f=this.cropStartDimensions.left-(c-this.cropStartDimensions.width)),(o||r)&&(D=c),(l||u)&&(d=v),D<=0&&(D=Math.abs(D),o?(o=!1,r=!0,f-=D):(o=!0,r=!1,f=this.cropStartDimensions.left-D)),d<=0&&(d=Math.abs(d),l?(l=!1,u=!0,m-=d):(l=!0,u=!1,m=this.cropStartDimensions.top-d)),s.f.value){let t=null,e=null;if(!s.eb.value||!l&&!u)if(o||n){t=this.snapPointX(f);let e=(null!=t?t:f)-f;if(f+=e,n){const e=Math.floor(D/2);let i=this.snapPointX(f+e);null!=i&&(t=i,f=(null!=t?t:f+e)-e);let n=this.snapPointX(f+D);null!=n&&(t=n,f=(null!=t?t:f+D)-D)}else D-=e}else r&&(t=this.snapPointX(f+D),D=(null!=t?t:f+D)-f);if(l||n){e=this.snapPointY(m);let t=(null!=e?e:m)-m;if(m+=t,n){const t=Math.floor(d/2);let i=this.snapPointY(m+t);null!=i&&(e=i,m=(null!=e?e:m+t)-t);let n=this.snapPointY(m+d);null!=n&&(e=n,m=(null!=e?e:m+d)-d)}else d-=t}else u&&(e=this.snapPointY(m+d),d=(null!=e?e:m+d)-m);s.Pt.value=t,s.dD.value=e}if(s.eb.value)if(l||u){let t=D;D=Math.round(d*s.eb.value),o&&(f+=t-D)}else d=Math.round(D/s.eb.value);s.D5.emit("setCrop",{top:m,left:f,width:D,height:d})}if(!this.cropTranslateStart&&t.isPrimary&&["mouse","pen"].includes(t.pointerType)){const t=a.Z.get("transform"),e=a.Z.get("decomposedTransform"),i=new DOMPoint(this.lastCursorX*devicePixelRatio,this.lastCursorY*devicePixelRatio).matrixTransform(t.inverse());let n=this.getCropDragType(i,e);s.G0.value=null!=n?n:null}}onPointerUp(t){super.onPointerUp(t),t.isPrimary&&(this.cropTranslateStart&&(s.bf.value=Math.max(1,s.bf.value),s.Cb.value=Math.max(1,s.Cb.value),s.Pt.value=null,s.dD.value=null,this.cropTranslateStart=null),s.G0.value=null)}getCropDragType(t,e){const i=window.devicePixelRatio||1;let n=0;const a=2*this.remToPx/e.scaleX*i;return t.y>=s.we.value-a&&t.y<=s.we.value+a&&(n|=1),t.y>=s.we.value+s.Cb.value-a&&t.y<=s.we.value+s.Cb.value+a&&(n|=2),t.x>=s.t$.value-a&&t.x<=s.t$.value+a&&(n|=4),t.x>=s.t$.value+s.bf.value-a&&t.x<=s.t$.value+s.bf.value+a&&(n|=8),(t.x<s.t$.value-a||t.x>s.t$.value+s.bf.value+a||t.y<s.we.value-a||t.y>s.we.value+s.Cb.value+a)&&(n=null),n}snapPointX(t){const e=this.snapSensitivity;for(let i of this.xAxisSnap){if(t-e<i&&t+e>i)return i;if(i-e>t)break}return null}snapPointY(t){const e=this.snapSensitivity;for(let i of this.yAxisSnap){if(t-e<i&&t+e>i)return i;if(i-e>t)break}return null}}}}]);