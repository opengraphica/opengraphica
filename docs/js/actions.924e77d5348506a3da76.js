"use strict";(self.webpackChunkOpenGraphica=self.webpackChunkOpenGraphica||[]).push([[8107],{24817:(e,t,s)=>{s.d(t,{s:()=>d});var a=s(27462),i=s(77854),r=s(75710),o=s(91648),n=s(19971),l=s(48050);class d extends a.Y{doNotClearActiveSelection=!1;activeSelectionPath=[];drawMargin=0;newMaskOffset=new DOMPoint;newMaskDatabaseId=null;newMaskDatabaseSizeEstimate=0;oldMaskOffset=new DOMPoint;oldMaskDatabaseId=null;oldMaskDatabaseSizeEstimate=0;oldSelectionCombineMode=null;constructor(e=r.iU.value,t={}){super("applyActiveSelection","action.applyActiveSelection"),this.activeSelectionPath=e,this.drawMargin=r.Jn.value,this.doNotClearActiveSelection=t.doNotClearActiveSelection||!1}async do(){if(super.do(),r.Kk.value&&!this.oldMaskDatabaseId){try{let e=await fetch(r.Kk.value.src).then((e=>e.blob()));e&&(this.oldMaskDatabaseId=await i.Z.add(e),this.oldMaskDatabaseSizeEstimate=e.size),e=null}catch(e){throw new Error("Aborted - Error storing old selection mask.")}this.oldMaskOffset=new DOMPoint,this.oldMaskOffset.x=r.pt.value.x,this.oldMaskOffset.y=r.pt.value.y}this.oldSelectionCombineMode=r.B3.value;let e=null,t=null;if(null!=this.newMaskDatabaseId)try{t=await i.Z.get(this.newMaskDatabaseId)}catch(e){throw new Error("Aborted - problem retrieving cached image from database")}else if(this.activeSelectionPath.length>0){const e=(0,r._5)(this.activeSelectionPath);let s=await(0,r.tu)(e,this.activeSelectionPath);this.newMaskOffset.x=e.left-this.drawMargin,this.newMaskOffset.y=e.top-this.drawMargin,t=await new Promise(((e,t)=>{try{s?.toBlob((async a=>{if(a)try{this.newMaskDatabaseId=await i.Z.add(a),this.oldMaskDatabaseSizeEstimate=a.size,s=null,e(a)}catch(e){t(new Error("Aborted - Could not store new mask blob in databse."))}else t(new Error("Aborted - Canvas blob not created when drawing new selection shape."))}),"image/png",1)}catch(e){t(e)}}))}t&&(e=await(0,l.pm)(t)),r.Kk.value&&URL.revokeObjectURL(r.Kk.value.src),r.Kk.value=e,r.pt.value.x=this.newMaskOffset.x,r.pt.value.y=this.newMaskOffset.y,r.R_.value=null,r.ot.value.x=0,r.ot.value.y=0,this.doNotClearActiveSelection?this.doNotClearActiveSelection=!1:r.iU.value=[],this.freeEstimates.database=this.newMaskDatabaseSizeEstimate+this.oldMaskDatabaseSizeEstimate,o.Z.set("viewDirty",!0)}async undo(){super.undo();let e=null,t=null;if(null!=this.oldMaskDatabaseId)try{t=await i.Z.get(this.oldMaskDatabaseId)}catch(e){throw new Error("Aborted - Failed to retrieve image from store")}t&&(e=await(0,l.pm)(t)),r.Kk.value&&URL.revokeObjectURL(r.Kk.value.src),r.Kk.value=e,r.pt.value.x=this.oldMaskOffset.x,r.pt.value.y=this.oldMaskOffset.y,this.oldSelectionCombineMode&&(r.B3.value=this.oldSelectionCombineMode),r.iU.value=[...this.activeSelectionPath],r.iU.value.length>0&&"selection"!==n.default.get("activeToolGroup")&&n.default.dispatch("setActiveTool",{group:"selection"}),await(0,r.Ie)(),o.Z.set("viewDirty",!0)}free(){super.free(),this.newMaskDatabaseId&&i.Z.delete(this.newMaskDatabaseId),this.oldMaskDatabaseId&&i.Z.delete(this.oldMaskDatabaseId),this.newMaskOffset=null,this.newMaskDatabaseId=null,this.newMaskDatabaseSizeEstimate=0,this.oldMaskOffset=null,this.oldMaskDatabaseId=null,this.oldMaskDatabaseSizeEstimate=0}}},27462:(e,t,s)=>{s.d(t,{Y:()=>a});class a{id;description;done=!1;thumbnail;freeEstimates={memory:0,database:0};get isDone(){return this.done}get memoryEstimate(){return this.freeEstimates.memory}get databaseEstimate(){return this.freeEstimates.database}constructor(e,t){this.id=e,this.description=t}async do(){this.done=!0}async undo(){this.done=!1}free(){}}},93249:(e,t,s)=>{s.d(t,{x:()=>r});var a=s(91648),i=s(27462);class r extends i.Y{actions;constructor(e,t,s){super(e,t),this.actions=s}async do(){super.do();let e=null,t=0;for(this.freeEstimates.memory=0,this.freeEstimates.database=0,t=0;t<this.actions.length;t++)try{await this.actions[t].do(),this.freeEstimates.memory+=this.actions[t].freeEstimates.memory,this.freeEstimates.database+=this.actions[t].freeEstimates.database}catch(t){e=t;break}if(e){for(t--;t>=0;t--)await this.actions[t].undo();throw e}a.Z.set("dirty",!0)}async undo(){super.undo(),this.freeEstimates.memory=0,this.freeEstimates.database=0;for(let e=this.actions.length-1;e>=0;e--)await this.actions[e].undo(),this.freeEstimates.memory+=this.actions[e].freeEstimates.memory,this.freeEstimates.database+=this.actions[e].freeEstimates.database;a.Z.set("dirty",!0)}free(){if(this.actions){for(let e of this.actions)e.free();this.actions=null}}}},57753:(e,t,s)=>{s.d(t,{m:()=>d});var a=s(27462),i=s(77854),r=s(75710),o=s(91648),n=s(19971),l=s(48050);class d extends a.Y{oldActiveSelectionPath=[];oldAppliedMaskOffset=new DOMPoint;oldAppliedMaskDatabaseId=null;oldAppliedMaskDatabaseSizeEstimate=0;oldSelectionCombineMode=null;constructor(){super("clearSelection","action.clearSelection")}async do(){if(super.do(),r.Kk.value&&!this.oldAppliedMaskDatabaseId){try{let e=await fetch(r.Kk.value.src).then((e=>e.blob()));e&&(this.oldAppliedMaskDatabaseId=await i.Z.add(e),this.oldAppliedMaskDatabaseSizeEstimate=e.size),e=null}catch(e){throw new Error("Aborted - Error storing old selection mask.")}this.oldAppliedMaskOffset=new DOMPoint}this.oldAppliedMaskOffset.x=r.pt.value.x,this.oldAppliedMaskOffset.y=r.pt.value.y,this.oldSelectionCombineMode=r.B3.value,this.oldActiveSelectionPath=[...r.iU.value],r.R_.value&&URL.revokeObjectURL(r.R_.value.src),r.R_.value=null,r.ot.value.x=0,r.ot.value.y=0,r.Kk.value&&URL.revokeObjectURL(r.Kk.value.src),r.Kk.value=null,r.pt.value.x=0,r.pt.value.y=0,r.iU.value=[],this.freeEstimates.database=this.oldAppliedMaskDatabaseSizeEstimate,o.Z.set("viewDirty",!0)}async undo(){super.undo();let e=null,t=null;if(null!=this.oldAppliedMaskDatabaseId)try{t=await i.Z.get(this.oldAppliedMaskDatabaseId)}catch(e){throw new Error("Aborted - Failed to retrieve image from store")}t&&(e=await(0,l.pm)(t)),r.Kk.value&&URL.revokeObjectURL(r.Kk.value.src),r.Kk.value=e,r.pt.value.x=this.oldAppliedMaskOffset.x,r.pt.value.y=this.oldAppliedMaskOffset.y,this.oldSelectionCombineMode&&(r.B3.value=this.oldSelectionCombineMode),r.iU.value=[...this.oldActiveSelectionPath],r.iU.value.length>0&&"selection"!==n.default.get("activeToolGroup")&&n.default.dispatch("setActiveTool",{group:"selection"}),await(0,r.Ie)(),o.Z.set("viewDirty",!0)}free(){super.free(),this.oldAppliedMaskDatabaseId&&i.Z.delete(this.oldAppliedMaskDatabaseId),this.oldActiveSelectionPath=null,this.oldAppliedMaskOffset=null,this.oldAppliedMaskDatabaseId=null,this.oldAppliedMaskDatabaseSizeEstimate=0}}},71045:(e,t,s)=>{s.d(t,{p:()=>l});var a=s(66252),i=s(27462),r=s(67340),o=s(95452),n=s(75710);class l extends i.Y{createFileOptions;previousState={};constructor(e){super("createNewFile","action.createNewFile"),this.createFileOptions=e}async do(){super.do();const e={activeTimelineId:this.createFileOptions.activeTimelineId||null,background:this.createFileOptions.background||{visible:!0,color:{is:"color",r:1,g:1,b:1,a:1,style:"#ffffff"}},colorModel:this.createFileOptions.colorModel||"rgba",drawOriginX:this.createFileOptions.drawOriginX||0,drawOriginY:this.createFileOptions.drawOriginY||0,fileHandle:null,fileName:this.createFileOptions.fileName||"",height:this.createFileOptions.height,layerIdCounter:this.createFileOptions.layerIdCounter||0,layers:[],measuringUnits:this.createFileOptions.measuringUnits||"px",resolutionUnits:this.createFileOptions.resolutionUnits||"px/in",resolutionX:this.createFileOptions.resolutionX||300,resolutionY:this.createFileOptions.resolutionY||300,scaleFactor:this.createFileOptions.scaleFactor||1,selectedLayerIds:this.createFileOptions.selectedLayerIds||[],timelineIdCounter:this.createFileOptions.timelineIdCounter||0,timelines:this.createFileOptions.timelines||[],width:this.createFileOptions.width};this.previousState={};for(let t in e)this.previousState[t]=r.default.get(t),r.default.set(t,e[t]),"layers"===t&&this.detachLayerRenderers(this.previousState[t]);(0,n.V7)(),(0,n.xH)(),n.iU.value=[],(0,r.calculateLayerOrder)(),await(0,a.Y3)(),o.Z.emit("app.canvas.resetTransform")}async undo(){super.undo();for(let e in this.previousState)r.default.set(e,this.previousState[e]),"layers"===e&&this.attachLayerRenderers(this.previousState[e]);this.previousState={},(0,n.V7)(),(0,n.xH)(),n.iU.value=[],(0,r.calculateLayerOrder)(),await(0,a.Y3)(),o.Z.emit("app.canvas.resetTransform")}attachLayerRenderers(e){for(const t of e)"group"===t.type&&this.attachLayerRenderers(t.layers),t.renderer.attach(t)}detachLayerRenderers(e){for(const t of e)"group"===t.type&&this.detachLayerRenderers(t.layers),t.renderer.detach()}}},16081:(e,t,s)=>{s.d(t,{R:()=>h});var a=s(27462),i=s(75710),r=s(91648),o=s(67340),n=s(48050),l=s(57753),d=s(75930),c=s(67091),u=s(2521);class h extends a.Y{selectNewLayers="none";clearSelection=!1;clearSelectionAction=null;insertLayerActions=[];selectLayersAction=null;constructor(e={}){super("createNewLayersFromSelection","action.createNewLayersFromSelection"),e.clearSelection&&(this.clearSelection=e.clearSelection),e.selectNewLayers&&(this.selectNewLayers=e.selectNewLayers)}async do(){if(super.do(),this.freeEstimates.memory=0,this.freeEstimates.database=0,0===this.insertLayerActions.length){const e=(0,o.getSelectedLayers)(),t=i.R_.value||i.Kk.value;if(!t)throw new Error("Aborted - No selection mask exists.");const s=t===i.R_.value?i.ot.value:i.pt.value,a=(0,n._7)((0,n.p7)(t)),l=document.createElement("canvas");l.width=a.right-a.left,l.height=a.bottom-a.top;const c=l.getContext("2d");if(!c)throw new Error("Aborted - Couldn't create canvas context.");c.imageSmoothingEnabled=!1,r.Z.get("decomposedTransform");for(let i of e)["raster","rasterSequence"].includes(i.type)&&(c.globalCompositeOperation="source-over",c.clearRect(0,0,l.width,l.height),c.save(),c.translate(-s.x-a.left,-s.y-a.top),"raster"===i.type?(new u.default["2d"].raster).draw(c,i):(new u.default["2d"].rasterSequence).draw(c,i),c.restore(),c.globalCompositeOperation="destination-in",c.drawImage(t,-a.left,-a.top),this.insertLayerActions.push(new d.D({type:"raster",name:(0,o.ensureUniqueLayerSiblingName)(i.id,i.name+" - Selection Copy"),width:l.width,height:l.height,transform:(new DOMMatrix).translateSelf(s.x+a.left,s.y+a.top),data:{sourceImage:await(0,n.dJ)(l),sourceImageIsObjectUrl:!0}})))}const e=o.default.get("selectedLayerIds");this.clearSelection&&!this.clearSelectionAction&&(this.clearSelectionAction=new l.m),this.clearSelectionAction&&(await this.clearSelectionAction.do(),this.freeEstimates.memory+=this.clearSelectionAction.freeEstimates.memory,this.freeEstimates.database+=this.clearSelectionAction.freeEstimates.database);let t=[];for(const e of this.insertLayerActions)await e.do(),t.push(e.insertedLayerId),this.freeEstimates.memory+=e.freeEstimates.memory,this.freeEstimates.database+=e.freeEstimates.database;"none"!==this.selectNewLayers&&(this.selectLayersAction&&(this.selectLayersAction.free(),this.selectLayersAction=null),"replace"===this.selectNewLayers?this.selectLayersAction=new c.h(t,e):this.selectLayersAction=new c.h([...o.default.get("selectedLayerIds"),...t],e)),this.selectLayersAction&&(await this.selectLayersAction.do(),this.freeEstimates.memory+=this.selectLayersAction.freeEstimates.memory,this.freeEstimates.database+=this.selectLayersAction.freeEstimates.database),r.Z.set("dirty",!0),r.Z.set("viewDirty",!0)}async undo(){super.undo(),this.freeEstimates.memory=0,this.freeEstimates.database=0;for(const e of this.insertLayerActions.slice().reverse())await e.undo(),this.freeEstimates.memory+=e.freeEstimates.memory,this.freeEstimates.database+=e.freeEstimates.database;this.clearSelectionAction&&(await this.clearSelectionAction.undo(),this.freeEstimates.memory+=this.clearSelectionAction.freeEstimates.memory,this.freeEstimates.database+=this.clearSelectionAction.freeEstimates.database),this.selectLayersAction&&(await this.selectLayersAction.undo(),this.freeEstimates.memory+=this.selectLayersAction.freeEstimates.memory,this.freeEstimates.database+=this.selectLayersAction.freeEstimates.database),r.Z.set("dirty",!0),r.Z.set("viewDirty",!0)}async free(){super.free();for(const e of this.insertLayerActions)e.free();this.selectLayersAction&&(this.selectLayersAction.free(),this.selectLayersAction=null),this.clearSelectionAction&&(this.clearSelectionAction.free(),this.clearSelectionAction=null),this.insertLayerActions=null}}},77854:(e,t,s)=>{s.d(t,{Z:()=>l});var a=s(44586);let i=null;try{i=sessionStorage.getItem("openGraphica_historyTabUuid")}catch(e){}if(!i){i=(0,a.Z)();try{sessionStorage.setItem("openGraphica_historyTabUuid",i+"")}catch(e){}}let r=0,o=null,n=null;const l={async init(){n?o||await n:(n=new Promise((async e=>{try{if(window.indexedDB){let e=!0;try{let t=localStorage.getItem("history_usage_ping");e=!t||parseInt(t,10)<(new Date).getTime()-3e5}catch(e){}if(e&&await new Promise(((e,t)=>{let s=window.indexedDB.deleteDatabase("undoHistoryImageStore");s.onerror=()=>{t(s.error)},s.onsuccess=()=>{e()}})),await new Promise(((e,t)=>{let s=window.indexedDB.open("undoHistoryImageStore",1);s.onupgradeneeded=function(e){o=s.result,0===e.oldVersion&&o.createObjectStore("images",{keyPath:"id"})},s.onerror=()=>{t(s.error)},s.onsuccess=()=>{e(),o=s.result}})),!o)throw new Error("indexedDB not initialized");o.isMemory=!1;try{await this.deleteAll()}catch(e){}localStorage.setItem("openGraphica_historyUsagePing",(new Date).getTime()+""),setInterval((()=>{localStorage.setItem("openGraphica_historyUsagePing",(new Date).getTime()+"")}),6e4)}}catch(e){o={isMemory:!0,images:{}}}e()})),await n)},async add(e){await this.init();let t=i+"-"+r++;return o?.isMemory?o.images[t]=e:await new Promise(((s,a)=>{const r=o.transaction("images","readwrite").objectStore("images"),n={id:t,tabUuid:i,data:e},l=r.add(n);l.onsuccess=function(){s()},l.onerror=function(){a(l.error)}})),t},async get(e){return await this.init(),o?.isMemory?o.images[e]:new Promise(((t,s)=>{const a=o.transaction("images","readonly").objectStore("images").get(e);a.onsuccess=function(){t(a.result&&a.result.data)},a.onerror=function(){s(a.error)}}))},async delete(e){if(await this.init(),!o?.isMemory)return new Promise(((t,s)=>{const a=o.transaction("images","readwrite").objectStore("images").delete(e);a.onsuccess=function(){t()},a.onerror=function(){s(a.error)}}));delete o.images[e]},async deleteAll(){if(await this.init(),!o?.isMemory)return new Promise(((e,t)=>{const s=o.transaction("images","readwrite").objectStore("images"),r=s.getAll();r.onsuccess=async function(){const t=r.result;let o=!1;for(let e of t)if(e.tabUuid===i)try{await new Promise(((t,a)=>{const i=s.delete(e.id);i.onsuccess=function(){t()},i.onerror=function(){a(i.error)}}))}catch(e){o=!0}o&&(i=(0,a.Z)()),e()},r.onerror=function(){t(r.error)}}));o.images={}}}},3652:(e,t,s)=>{s.d(t,{Il:()=>i,Gl:()=>o});let a=new Map;function i(e,t){if(e=e.toString()){let s=a.get(e)||[];s.includes(t)||s.push(t),a.set(e,s)}}function r(e){return e=e.toString(),(a.get(e)||[]).length>0}function o(e,t){(function(e,t){e=e.toString();let s=a.get(e)||[];s.splice(s.indexOf(t),1),0===s.length?a.delete(e):a.set(e,s)})(e=e.toString(),t),r||URL.revokeObjectURL(e)}},9091:(e,t,s)=>{s.d(t,{_:()=>l});var a=s(27462),i=s(67091),r=s(3652),o=s(91648),n=s(67340);class l extends a.Y{deleteLayerIds=[];deletedLayers=[];selectLayersAction=null;constructor(e){super("deleteLayers","action.deleteLayers"),this.deleteLayerIds=e}async do(){super.do(),this.selectLayersAction=new i.h([]),this.selectLayersAction.do();const e=n.default.get("layers");for(let t of this.deleteLayerIds){const s=(0,n.getLayerById)(t);if(s){let t=e;null!=s.groupId&&(t=(0,n.getGroupLayerById)(s.groupId,e)?.layers||e);let a=t.indexOf(s);a>-1&&(t.splice(t.indexOf(s),1),this.deletedLayers.unshift({layer:s,parentIndex:a})),s.renderer.detach()}}n.default.set("layers",e),(0,n.calculateLayerOrder)(),o.Z.set("dirty",!0)}async undo(){super.undo();const e=n.default.get("layers");for(let t of this.deletedLayers){const s=t.layer;let a=e;null!=s.groupId&&(a=(0,n.getGroupLayerById)(s.groupId)?.layers||e),a.splice(t.parentIndex,0,s),s.renderer.attach(s)}this.deletedLayers=[],n.default.set("layers",e),this.selectLayersAction&&(this.selectLayersAction.undo(),this.selectLayersAction=null),(0,n.calculateLayerOrder)(),o.Z.set("dirty",!0)}free(){super.free();for(let e of this.deletedLayers){const t=e.layer;if("raster"===t.type&&t.data.sourceImage&&t.data.sourceImageIsObjectUrl&&(0,r.Gl)(t.data.sourceImage.src,t.id),"rasterSequence"===t.type)for(let e of t.data.sequence)e.image.sourceImage&&e.image.sourceImageIsObjectUrl&&(0,r.Gl)(e.image.sourceImage.src,t.id)}this.deleteLayerIds=null,this.deletedLayers=null,this.selectLayersAction&&(this.selectLayersAction.free(),this.selectLayersAction=null)}}},75930:(e,t,s)=>{s.d(t,{D:()=>u});var a=s(2262),i=s(27462),r=s(67091),o=s(3652),n=s(91648),l=s(67340),d=s(2521);let c=1;class u extends i.Y{insertedLayerId=-1;insertLayerOptions=null;insertPosition="top";insertAroundLayerId=0;insertedLayer=null;selectLayersAction=null;constructor(e,t="top",s){super("insertLayer","action.insertLayer"),this.insertLayerOptions=e,this.insertPosition=t,null!=s&&(this.insertAroundLayerId=s)}async do(){super.do();let e=-1;null!=this.insertLayerOptions?.id?e=this.insertLayerOptions.id:(e=l.default.get("layerIdCounter"),l.default.set("layerIdCounter",e+1)),this.insertedLayerId=e;const t=n.Z.get("renderer");let s;if(this.insertedLayer)s=this.insertedLayer;else{if(!this.insertLayerOptions)throw new Error("Layer definition for insertion not found.");{const i={type:"raster",bakedImage:null,blendingMode:"source-over",filters:[],id:e,groupId:null,height:1,width:1,name:"New Layer #"+c++,opacity:1,thumbnailImageSrc:null,transform:new DOMMatrix,visible:!0,renderer:new d.default[t].base};switch(this.insertLayerOptions.type){case"empty":s={...i,renderer:new d.default[t].empty,...this.insertLayerOptions};break;case"group":s={...i,layers:[],expanded:!1,renderer:new d.default[t].group,...this.insertLayerOptions};break;case"raster":s={...i,renderer:new d.default[t].raster,data:{},...this.insertLayerOptions},s.data.sourceImageIsObjectUrl&&(0,o.Il)(s.data.sourceImage?.src,e);break;case"rasterSequence":s={...i,data:{},renderer:new d.default[t].rasterSequence,...this.insertLayerOptions};for(let t of s.data.sequence)t.image.sourceImageIsObjectUrl&&(0,o.Il)(t.image.sourceImage?.src,e);break;case"vector":s={...i,data:[],renderer:new d.default[t].vector,...this.insertLayerOptions};break;case"text":s={...i,data:{},renderer:new d.default[t].text,...this.insertLayerOptions}}s=(0,a.qj)(s),this.insertedLayer=s,this.insertLayerOptions=null}}const i=l.default.get("layers");let u=i;if(null!=s.groupId){const e=(0,l.getGroupLayerById)(s.groupId,u);e&&(u=e.layers)}if(!u)throw new Error("Parent group not found.");if(["above","below"].includes(this.insertPosition)){let e=-1;for(let[t,s]of u.entries())if(s.id===this.insertAroundLayerId){e=t;break}if(!(e>-1))throw new Error("Referenced layer to insert around not found.");u.splice(e+("above"===this.insertPosition?1:0),0,s)}else"top"===this.insertPosition?u.push(s):"bottom"===this.insertPosition&&u.unshift(s);s.renderer.attach(s),l.default.set("layers",i),this.selectLayersAction=new r.h([s.id]),this.selectLayersAction.do(),(0,l.calculateLayerOrder)(),n.Z.set("dirty",!0)}async undo(){super.undo(),this.selectLayersAction&&(this.selectLayersAction.undo(),this.selectLayersAction=null);const e=l.default.get("layers");let t=e;if(null!=this.insertedLayer&&null!=this.insertedLayer.groupId){const e=(0,l.getGroupLayerById)(this.insertedLayer.groupId,t);e&&(t=e.layers)}if(this.insertedLayer&&t){let e=t.findIndex((e=>e.id===this.insertedLayer.id));t.splice(e,1)}this.insertedLayer&&this.insertedLayer.renderer.detach(),l.default.set("layers",e),l.default.set("layerIdCounter",l.default.get("layerIdCounter")-1),this.insertedLayerId=-1,(0,l.calculateLayerOrder)(),n.Z.set("dirty",!0)}free(){if(super.free(),this.selectLayersAction&&(this.selectLayersAction.free(),this.selectLayersAction=null),this.insertedLayer&&!this.isDone)if("raster"===this.insertedLayer.type)this.insertedLayer.data.sourceImage&&this.insertedLayer.data.sourceImageIsObjectUrl&&(0,o.Gl)(this.insertedLayer.data.sourceImage?.src,this.insertedLayer.id);else if("rasterSequence"===this.insertedLayer.type)for(let e of this.insertedLayer.data.sequence)e.image.sourceImage&&e.image.sourceImageIsObjectUrl&&(0,o.Gl)(e.image.sourceImage?.src,this.insertedLayer.id);this.insertedLayer=null,this.insertLayerOptions=null}}},6669:(e,t,s)=>{s.d(t,{d:()=>o});var a=s(27462),i=s(91648),r=s(67340);class o extends a.Y{insertLayerIds;referenceLayerId;insertPosition;insertLayerPreviousPositions=[];constructor(e,t,s){super("reorderLayers","action.reorderLayers"),this.insertLayerIds=e,this.referenceLayerId=t,this.insertPosition=s}async do(){super.do();let e=[];for(let t of this.insertLayerIds){const s=(0,r.getLayerById)(t);if(!s)throw new Error("Cannot find insert layer.");e.push(s)}for(let t of e)if(t){const e=this.getLayerParent(t.id).layers,s=e.indexOf(t);e.splice(s,1),this.insertLayerPreviousPositions.push({groupId:t.groupId,index:s})}let t=(0,r.getLayerById)(this.referenceLayerId);if(!t)throw new Error("Cannot find reference layer.");if("below"===this.insertPosition||"above"===this.insertPosition){let s=this.getLayerParent(this.referenceLayerId);s.layers.splice(s.layers.indexOf(t)+("below"===this.insertPosition?0:1),0,...e);for(let t of e)t.groupId=s.id}else{const s=t;if(!s)throw new Error("Reference layer is not a group layer.");s.layers.splice("bottomChild"===this.insertPosition?0:s.layers.length,0,...e);for(let t of e)t.groupId=s.id}r.default.set("layers",[...r.default.get("layers")]),(0,r.calculateLayerOrder)(),i.Z.set("dirty",!0)}async undo(){super.undo();let e=[];for(let t of this.insertLayerIds){const s=(0,r.getLayerById)(t);if(!s)throw new Error("Cannot find insert layer.");e.push(s)}let t=(0,r.getLayerById)(this.referenceLayerId);if(!t)throw new Error("Cannot find reference layer.");if("below"===this.insertPosition||"above"===this.insertPosition){let s=this.getLayerParent(this.referenceLayerId);s.layers.splice(s.layers.indexOf(t)+("below"===this.insertPosition?-1:1),e.length)}else{const s=t;if(!s)throw new Error("Reference layer is not a group layer.");s.layers.splice("bottomChild"===this.insertPosition?0:s.layers.length-1,e.length)}let s=this.insertLayerPreviousPositions.slice().reverse();for(let[t,a]of e.slice().reverse().entries())if(a){const e=s[t].groupId,i=null==e?r.default.get("layers"):(0,r.getGroupLayerById)(e)?.layers;if(!i)throw new Error("Could not find layer parent.");i.splice(s[t].index,0,a),a.groupId=e}r.default.set("layers",[...r.default.get("layers")]),(0,r.calculateLayerOrder)(),i.Z.set("dirty",!0)}free(){super.free()}getLayerParent(e){let t={id:null,layers:r.default.get("layers")};const s=(0,r.getLayerById)(e);if(s&&null!=s.groupId){const e=(0,r.getGroupLayerById)(s.groupId,t.layers);e&&(t={id:e.id,layers:e.layers})}return t}}},67091:(e,t,s)=>{s.d(t,{h:()=>o});var a=s(27462),i=s(91648),r=s(67340);class o extends a.Y{newSelectedLayerIds;previousSelectedLayerIds=[];previousSelectedLayerIdsOverride=null;constructor(e,t){super("selectLayers","action.selectLayers"),this.newSelectedLayerIds=e,t&&(this.previousSelectedLayerIdsOverride=t)}async do(){super.do(),this.previousSelectedLayerIdsOverride?this.previousSelectedLayerIds=this.previousSelectedLayerIdsOverride:this.previousSelectedLayerIds=r.default.get("selectedLayerIds"),r.default.set("selectedLayerIds",[...this.newSelectedLayerIds]),i.Z.set("dirty",!0)}async undo(){super.undo(),r.default.set("selectedLayerIds",[...this.previousSelectedLayerIds]),i.Z.set("dirty",!0)}free(){super.free()}}},3057:(e,t,s)=>{s.d(t,{w:()=>n});var a=s(27462),i=s(75710),r=s(91648),o=s(19971);class n extends a.Y{newActiveSelectionPath=[];oldActiveSelectionPath=[];oldSelectionCombineMode=null;constructor(e,t){super("updateActiveSelection","action.updateActiveSelection"),this.newActiveSelectionPath=e,this.oldActiveSelectionPath=t||[...i.iU.value],this.oldSelectionCombineMode=i.B3.value}async do(){super.do(),i.iU.value=this.newActiveSelectionPath,i.iU.value.length>0&&"selection"!==o.default.get("activeToolGroup")&&o.default.dispatch("setActiveTool",{group:"selection"}),await(0,i.Ie)(),r.Z.set("viewDirty",!0)}async undo(){super.undo(),this.oldSelectionCombineMode&&(i.B3.value=this.oldSelectionCombineMode),i.iU.value=this.oldActiveSelectionPath,i.iU.value.length>0&&"selection"!==o.default.get("activeToolGroup")&&o.default.dispatch("setActiveTool",{group:"selection"}),await(0,i.Ie)(),r.Z.set("viewDirty",!0)}async free(){super.free(),this.newActiveSelectionPath=null,this.oldActiveSelectionPath=null}}},23120:(e,t,s)=>{s.d(t,{_:()=>n});var a=s(27462),i=s(91648),r=s(67340),o=s(95452);class n extends a.Y{updateFileOptions;previousState={};constructor(e){super("updateFile","action.updateFile"),this.updateFileOptions=e}async do(){super.do();for(let e in this.updateFileOptions)this.previousState[e]=r.default.get(e),r.default.set(e,this.updateFileOptions[e]);i.Z.set("dirty",!0),(this.updateFileOptions.width||this.updateFileOptions.height)&&o.Z.emit("app.canvas.resetTransform")}async undo(){super.undo();for(let e in this.previousState)r.default.set(e,this.previousState[e]);i.Z.set("dirty",!0),(this.previousState.width||this.previousState.height)&&o.Z.emit("app.canvas.resetTransform")}free(){super.free(),this.updateFileOptions=null,this.previousState=null}}},32988:(e,t,s)=>{s.d(t,{E:()=>d});var a=s(27462),i=s(77854),r=s(3652),o=s(48050),n=s(91648),l=s(67340);class d extends a.Y{updateLayerOptions;previousProps={};explicitPreviousProps={};newRasterSourceImageDatabaseId=null;oldRasterSourceImageDatabaseId=null;constructor(e,t={}){super("updateLayer","action.updateLayer"),this.updateLayerOptions=e,this.explicitPreviousProps=t}async do(){super.do();const e=l.default.get("layers"),t=(0,l.getLayerById)(this.updateLayerOptions.id,e);if(!t)throw new Error("Aborted - Layer with specified id not found.");for(let e in this.updateLayerOptions)if("data"===e){if("raster"===t.type){const s=this.updateLayerOptions[e];if(null!=this.newRasterSourceImageDatabaseId)t.data.sourceImage=await(0,o.pm)(await i.Z.get(this.newRasterSourceImageDatabaseId)),t.data.sourceImageIsObjectUrl=!0;else if(s?.sourceImage){if(t.data.sourceImage)try{this.oldRasterSourceImageDatabaseId=await i.Z.add(await fetch(t.data.sourceImage.src).then((e=>e.blob()))),this.newRasterSourceImageDatabaseId=await i.Z.add(await fetch(s.sourceImage.src).then((e=>e.blob()))),t.data.sourceImageIsObjectUrl&&(0,r.Gl)(t.data.sourceImage.src,t.id)}catch(e){throw new Error("Aborted - Error storing old image.")}t.data.sourceImage=s.sourceImage,t.data.sourceImageIsObjectUrl=s.sourceImageIsObjectUrl,(0,r.Il)(t.data.sourceImage.src,t.id)}}}else"id"!==e&&(void 0!==this.explicitPreviousProps[e]?this.previousProps[e]=this.explicitPreviousProps[e]:this.previousProps[e]=t[e],t[e]=this.updateLayerOptions[e]);this.regenerateThumbnail(t),n.Z.set("dirty",!0)}async undo(){super.undo();const e=l.default.get("layers"),t=(0,l.getLayerById)(this.updateLayerOptions.id,e);if(t){for(let e in this.previousProps)"id"!==e&&(t[e]=this.previousProps[e]);if(this.regenerateThumbnail(t),"raster"===t.type&&null!=this.oldRasterSourceImageDatabaseId){const e=t.data.sourceImageIsObjectUrl,s=t.data.sourceImage?.src;t.data.sourceImage=await(0,o.pm)(await i.Z.get(this.oldRasterSourceImageDatabaseId)),t.data.sourceImageIsObjectUrl=!0,(0,r.Il)(t.data.sourceImage.src,t.id),e&&(0,r.Gl)(s,t.id)}}n.Z.set("dirty",!0)}free(){if(super.free(),this.previousProps&&!this.isDone){const e=this.previousProps.data,t=(0,l.getLayerById)(this.updateLayerOptions.id);if(e&&t)if("raster"===t.type)e.sourceImage&&e.sourceImageIsObjectUrl&&(0,r.Gl)(e.sourceImage.src,t.id);else if("rasterSequence"===t.type)for(let s of e.sequence)s.image.sourceImage&&s.image.sourceImageIsObjectUrl&&(0,r.Gl)(s.image.sourceImage.src,t.id)}null!=this.newRasterSourceImageDatabaseId&&(i.Z.delete(this.newRasterSourceImageDatabaseId),this.newRasterSourceImageDatabaseId=null),null!=this.oldRasterSourceImageDatabaseId&&(i.Z.delete(this.oldRasterSourceImageDatabaseId),this.oldRasterSourceImageDatabaseId=null),this.updateLayerOptions=null,this.previousProps=null}regenerateThumbnail(e){let t=e;for(;null!=t;)t.thumbnailImageSrc=null,t=null!=t.groupId?(0,l.getGroupLayerById)(t.groupId):null}}},8043:(e,t,s)=>{s.d(t,{U:()=>r});var a=s(27462),i=s(75710);class r extends a.Y{newSelectionCombineMode;oldSelectionCombineMode;constructor(e,t){super("updateSelectionCombineMode","action.updateSelectionCombineMode"),this.newSelectionCombineMode=e,this.oldSelectionCombineMode=t||i.B3.value}async do(){super.do(),i.B3.value=this.newSelectionCombineMode}async undo(){super.undo(),i.B3.value=this.oldSelectionCombineMode}async free(){super.free(),this.newSelectionCombineMode=null,this.oldSelectionCombineMode=null}}}}]);