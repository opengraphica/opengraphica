"use strict";(self.webpackChunkOpenGraphica=self.webpackChunkOpenGraphica||[]).push([[7804],{98898:(e,a,l)=>{l.r(a),l.d(a,{default:()=>ge});var t=l(66252),i=l(3577);const n={class:"ogr-dock-header"},r={class:"is-flex is-align-items-center is-justify-content-center"},o={class:"has-text-color-regular mr-3"},s=(0,t._)("span",{class:"bi bi-plus-circle mr-1","aria-hidden":"true"},null,-1),d=(0,t._)("span",{class:"bi bi-images mr-1","aria-hidden":"true"},null,-1),u={class:"ogr-dock-content is-spaced-between"},c={class:"ogr-layer-list"},g={class:"ogr-layer-main"},p={class:"ogr-layer-thumbnail"},y={class:"ogr-layer-name"};var m=l(2262),h=l(26418),b=l(64670),v=l(43019),f=l(17765),w=l(53430),L=l(49963);const k=["data-layer-id"],S={class:"ogr-layer-main"},_=["onMouseenter","onMouseleave"],C={class:"ogr-layer-name"},I=(0,t._)("i",{class:"bi bi-three-dots-vertical","aria-hidden":"true"},null,-1),x=(0,t._)("i",{class:"bi bi-trash"},null,-1),D={key:1,role:"group",class:"ogr-layer-attributes ogr-layer-frames"},H={class:"ogr-layer-attributes__title"},T=(0,t._)("i",{class:"bi bi-arrow-return-right","aria-hidden":"true"},null,-1),q=(0,t._)("i",{class:"bi bi-play","aria-hidden":"true"},null,-1),A=(0,t._)("i",{class:"bi bi-stop","aria-hidden":"true"},null,-1),P={class:"is-flex"},Z={class:"ogr-layer-frames-list"},B=(0,t._)("i",{class:"bi bi-pencil-square","aria-hidden":"true"},null,-1),M=["innerHTML"];var E=l(37447),F=l(41627),W=l(68444),j=l(91648),$=l(19971),R=l(8778),Y=l(67340);const z={class:"ogr-layer-thumbnail"},V={key:0,class:"bi bi-folder2-open has-text-color-secondary","aria-hidden":"true"},U=["src"];var N=l(2521);const G=(0,t.aZ)({name:"AppLayerListThumbnail",directives:{loading:v.ZP.directive},components:{},props:{layer:{type:Object,required:!0}},setup(e,{emit:a}){const l=70,i=(0,t.Fl)((()=>Y.default.state.width>Y.default.state.height)),n=(0,t.Fl)((()=>{if(!e.layer.thumbnailImageSrc){const a=document.createElement("canvas"),t=Y.default.state.width,i=Y.default.state.height;let n=1,r=1,o=1;t>i?(n=l,o=l/t,r=Math.floor(i/t*l)):(r=l,o=l/i,n=Math.floor(t/i*l)),a.width=n,a.height=r;let s=a.getContext("2d");s.scale(o,o),(new N.default["2d"][e.layer.type]).draw(s,e.layer,{visible:!0}),e.layer.thumbnailImageSrc=a.toDataURL()}return e.layer.thumbnailImageSrc}));return{isLargerWidth:i,thumbnailImageSrc:n}}});var O=l(83744);const K=(0,O.Z)(G,[["render",function(e,a,l,n,r,o){return(0,t.wg)(),(0,t.iD)("div",z,[e.layer.expanded?((0,t.wg)(),(0,t.iD)("span",V)):((0,t.wg)(),(0,t.iD)("img",{key:1,src:e.thumbnailImageSrc,alt:"thumbnail",class:(0,i.normalizeClass)({"is-larger-width":e.isLargerWidth}),onTouchstart:a[0]||(a[0]=e=>e.preventDefault())},null,42,U))])}]]),Q=["src"],J={class:"ogr-layer-thumbnail__label"},X=(0,t.aZ)({name:"AppLayerFrameThumbnail",directives:{loading:v.ZP.directive},components:{},props:{layer:{type:Object,required:!0},sequenceIndex:{type:Number,required:!0}},setup(e,{emit:a}){const l=70,i=(0,m.iH)(!1),n=(0,t.Fl)((()=>e.layer.width>e.layer.height)),r=(0,t.Fl)((()=>{const a=e.layer.data.sequence[e.sequenceIndex];if(!a.thumbnailImageSrc&&a.image.sourceImage){const t=document.createElement("canvas"),i=e.layer.width,n=e.layer.height;let r=1,o=1,s=1;i>n?(r=l,s=l/i,o=Math.floor(n/i*l)):(o=l,s=l/n,r=Math.floor(i/n*l)),t.width=r,t.height=o;let d=t.getContext("2d");d.scale(s,s),d.drawImage(a.image.sourceImage,0,0),a.thumbnailImageSrc=t.toDataURL()}return a.thumbnailImageSrc||""}));return(0,t.YP)((()=>$.default.state.timelineCursor),(()=>{i.value=e.layer.data.currentFrame===e.layer.data.sequence[e.sequenceIndex].image}),{immediate:!0}),{isActiveLayer:i,isLargerWidth:n,thumbnailImageSrc:r}}}),ee=(0,O.Z)(X,[["render",function(e,a,l,n,r,o){return(0,t.wg)(),(0,t.iD)("div",{class:(0,i.normalizeClass)(["ogr-layer-thumbnail",{"is-active":e.isActiveLayer}])},[(0,t._)("img",{src:e.thumbnailImageSrc,alt:"thumbnail",class:(0,i.normalizeClass)({"is-larger-width":e.isLargerWidth})},null,10,Q),(0,t._)("div",J,(0,i.toDisplayString)(e.sequenceIndex),1)],2)}]]);var ae=l(93249),le=l(9091),te=l(67091),ie=l(32988),ne=l(6669);const re=(0,t.aZ)({name:"AppLayerList",directives:{loading:v.ZP.directive,pointer:W.Z},components:{AppLayerListThumbnail:K,AppLayerFrameThumbnail:ee,ElAlert:h.ZP,ElButton:b.ZP,ElMenu:E.default,ElMenuItem:E.ElMenuItem,ElPopover:F.ZP,ElScrollbar:f.default},props:{depth:{type:Number,default:0},isRoot:{type:Boolean,default:!1},layers:{type:Array,required:!0},scrollContainerHeight:{type:Number,default:0},scrollTop:{type:Number,default:0}},emits:["scroll-by"],setup(e,{emit:a}){const l=(0,m.iH)(null),i=(0,m.iH)(null),n=(0,m.iH)(null),r=(0,m.iH)("above"),o=(0,m.iH)(null);let s=0,d=0,u=[],c=0,g=0,p=!1,y=null;const h=(0,m.iH)(null),b=(0,m.iH)(""),v=(0,m.iH)(null),f=e.isRoot?"dragstart":"",{playingAnimation:w}=(0,m.BK)(j.Z.state),{selectedLayerIds:L}=(0,m.BK)(Y.default.state),k=(0,t.Fl)((()=>function(e){const a=[];for(let l=e.length-1;l>=0;l--)a.push((0,m.qj)(e[l]));return a}(e.layers)));async function S(a){y=a.pointerId;const n=a.target,r=a.pageY;g=r;const o=n?.closest(".ogr-layer-dnd-handle")?.closest(".ogr-layer");if(o?.parentNode!==l.value)return;const p=parseInt(o?.getAttribute("data-layer-id")||"-1",10);if(p>-1&&o&&(c=e.scrollTop,u=[],l.value.querySelectorAll(":scope > .ogr-layer:not(.is-dragging)").forEach((e=>{const a=e.getBoundingClientRect();u.push({isExpanded:e.classList.contains("is-expanded"),top:a.top+window.scrollY,height:a.height,id:parseInt(e.getAttribute("data-layer-id")+"",10)})})),h.value=p,b.value=o.innerHTML,await(0,t.Y3)(),i.value)){const e=o.getBoundingClientRect(),a=l.value.getBoundingClientRect().top+window.scrollY,t=e.top+window.scrollY;s=r-t,d=e.height,i.value.style.top=r-a-s+"px"}}function _(t){if(i.value){n.value=null;const o=l.value.getBoundingClientRect().top+window.scrollY;i.value.style.top=t-o-s+"px";const y=64,m=t-s,b=m+d,v=m+(e.scrollTop-c),f=b+(e.scrollTop-c);t<g?p=!0:t>g&&(p=!1);let w=0,L=-1;for(let e=0;e<u.length;e++){let a=0,l=-1;u[e+1]&&(a=u[e+1].height/2,l=u[e+1].id);const t=u[e],i=t.top+t.height/2;t.isExpanded&&p&&v>t.top+y/4&&v<t.top+t.height-y/4||!p&&f>t.top+y/4&&f<t.top+t.height-y/4?(n.value=t.id,r.value="inside"):p&&(v<i&&v>t.top-w||0===e&&v<i)?t.id!==h.value&&L!==h.value&&(n.value=t.id,r.value="above"):!p&&(f<t.top+t.height+a&&f>i||e===u.length-1&&f>i)&&t.id!==h.value&&l!==h.value&&(n.value=t.id,r.value="below"),w=t.height/2,L=t.id}m-o-e.scrollTop<20&&a("scroll-by",-5),b-o-e.scrollTop>e.scrollContainerHeight-20&&a("scroll-by",5)}}async function C(e){null!=h.value&&null!=n.value&&h.value!==n.value&&await R.Z.dispatch("runAction",{action:new ne.d([h.value],n.value,"above"===r.value?"above":"inside"===r.value?"topChild":"below")}),h.value=null,b.value="",n.value=null}return(0,t.YP)((()=>e.scrollTop),(()=>{null!=h.value&&requestAnimationFrame((()=>{_(g)}))})),(0,t.bv)((()=>{})),(0,t.Ah)((()=>{})),{layerList:l,draggingLayer:i,conditionalDragStartEventModifier:f,draggingLayerId:h,dropTargetLayerId:n,dropTargetPosition:r,draggingItemHtml:b,selectedLayerIds:L,playingAnimation:w,hoveringLayerId:o,showLayerSettingsMenuFor:v,onLayerSettingsSelect:async function(e,a){"delete"===a&&R.Z.dispatch("runAction",{action:new le._([e.id])}),v.value=null},onMouseEnterDndHandle:function(e){o.value=e.id},onMouseLeaveDndHandle:function(e){o.value=null},onPointerTapDndHandle:function(e){const a=parseInt(e.target?.closest(".ogr-layer")?.getAttribute("data-layer-id")||"-1",10),l=(0,Y.getLayerById)(a);l&&("group"===l.type&&(l.expanded=!l.expanded),Y.default.get("selectedLayerIds").includes(a)||R.Z.dispatch("runAction",{action:new te.h([a])}))},onPointerDragStartList:async function(e){"touch"!=e.pointerType&&S(e)},onPointerDragEndList:C,onPointerMoveList:function(e){if(null!=h.value){const a=e.pageY;_(a),g=a}},onPointerUpList:function(e){e.pointerId===y&&C()},onPointerPressList:function(e){"touch"===e.pointerType&&S(e)},onToggleLayerSettings:function(e){v.value===e.id?v.value=null:v.value=e.id},onToggleLayerVisibility:function(e){let a=e.visible;R.Z.dispatch("runAction",{action:new ae.x("toggleLayerVisibility","action.toggleLayerVisibility"+(a?"Off":"On"),[new ie.E({id:e.id,visible:!a})])})},onSelectLayerFrame:function(e,a){$.default.dispatch("setTimelineCursor",e.data.sequence[a].start)},onPlayRasterSequence:function(e){$.default.set({timelineEnd:e.data.sequence[e.data.sequence.length-1].end,timelinePlayStartTime:performance.now(),timelineStart:e.data.sequence[0].start}),$.default.dispatch("setTimelineCursor",e.data.sequence[0].start),j.Z.set("playingAnimation",!0)},onStopRasterSequence:function(){$.default.dispatch("setTimelineCursor",0),j.Z.set("playingAnimation",!1)},reversedLayers:k}}}),oe=(0,O.Z)(re,[["render",function(e,a,l,n,r,o){const s=(0,t.up)("app-layer-list-thumbnail"),d=(0,t.up)("el-button"),u=(0,t.up)("el-menu-item"),c=(0,t.up)("el-menu"),g=(0,t.up)("app-layer-frame-thumbnail"),p=(0,t.up)("el-scrollbar"),y=(0,t.up)("el-alert"),m=(0,t.up)("app-layer-list",!0),h=(0,t.Q2)("pointer"),b=(0,t.Q2)("t");return(0,t.wy)(((0,t.wg)(),(0,t.iD)("ul",{ref:"layerList",class:(0,i.normalizeClass)(["ogr-layer-list",{"is-dnd-dragging":null!=e.draggingLayerId}])},[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(e.reversedLayers,(l=>((0,t.wg)(),(0,t.iD)("li",{key:l.id,class:(0,i.normalizeClass)(["ogr-layer",{"is-dnd-hover":l.id===e.hoveringLayerId,"is-dnd-placeholder":l.id===e.draggingLayerId,"is-active":e.selectedLayerIds.includes(l.id),"is-expanded":l.expanded,"is-drag-insert-above":e.dropTargetLayerId===l.id&&"above"===e.dropTargetPosition,"is-drag-insert-below":e.dropTargetLayerId===l.id&&"below"===e.dropTargetPosition,"is-drag-insert-inside":e.dropTargetLayerId===l.id&&"inside"===e.dropTargetPosition}]),style:(0,i.normalizeStyle)({"--layer-group-indent":e.depth+"rem"}),"data-layer-id":l.id},[(0,t._)("span",S,[(0,t.wy)(((0,t.wg)(),(0,t.iD)("span",{class:"ogr-layer-dnd-handle",onMouseenter:a=>e.onMouseEnterDndHandle(l),onMouseleave:a=>e.onMouseLeaveDndHandle(l)},[(0,t.Wm)(s,{layer:l},null,8,["layer"]),(0,t._)("span",C,(0,i.toDisplayString)(l.name),1),"group"===l.type?((0,t.wg)(),(0,t.iD)("span",{key:0,class:(0,i.normalizeClass)(["ogr-layer-group-arrow bi",{"bi-chevron-right":!l.expanded,"bi-chevron-down":l.expanded}]),"aria-hidden":"true"},null,2)):(0,t.kq)("v-if",!0)],40,_)),[[h,e.onPointerTapDndHandle,void 0,{tap:!0}]]),(0,t.Wm)(d,{type:"text",class:"px-2","aria-label":e.$t("app.layerList.toggleLayerVisibility"),onClick:a=>e.onToggleLayerVisibility(l)},{default:(0,t.w5)((()=>[(0,t._)("i",{class:(0,i.normalizeClass)(["bi",{"bi-eye-fill":l.visible,"bi-eye-slash":!l.visible}]),"aria-hidden":"true"},null,2)])),_:2},1032,["aria-label","onClick"]),(0,t.Wm)(d,{type:"text",class:"px-2 mr-2 my-0 ml-0","aria-label":e.$t("app.layerList.layerSettings"),onClick:a=>e.onToggleLayerSettings(l)},{default:(0,t.w5)((()=>[I])),_:2},1032,["aria-label","onClick"])]),e.showLayerSettingsMenuFor===l.id?((0,t.wg)(),(0,t.j4)(c,{key:0,class:"el-menu--medium el-menu--borderless mb-1",onSelect:a=>e.onLayerSettingsSelect(l,a)},{default:(0,t.w5)((()=>[(0,t.Wm)(u,{index:"delete"},{default:(0,t.w5)((()=>[x,(0,t.wy)((0,t._)("span",null,null,512),[[b,"app.layerList.delete"]])])),_:1})])),_:2},1032,["onSelect"])):(0,t.kq)("v-if",!0),"rasterSequence"===l.type?((0,t.wg)(),(0,t.iD)("span",D,[(0,t._)("span",H,[T,(0,t.Uk)(" "+(0,i.toDisplayString)(e.$t("app.layerList.frames"))+" ",1),e.playingAnimation?((0,t.wg)(),(0,t.j4)(d,{key:1,type:"text",class:"p-0 ml-1",style:{"min-height":"0"},"aria-label":e.$t("app.layerList.stopAnimation"),onClick:a=>e.onStopRasterSequence(l)},{default:(0,t.w5)((()=>[A])),_:2},1032,["aria-label","onClick"])):((0,t.wg)(),(0,t.j4)(d,{key:0,type:"text",class:"p-0 ml-1",style:{"min-height":"0"},"aria-label":e.$t("app.layerList.playAnimation"),onClick:a=>e.onPlayRasterSequence(l)},{default:(0,t.w5)((()=>[q])),_:2},1032,["aria-label","onClick"]))]),(0,t._)("div",P,[(0,t.Wm)(p,null,{default:(0,t.w5)((()=>[(0,t._)("ul",Z,[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(l.data.sequence,((i,n)=>((0,t.wg)(),(0,t.iD)("li",{key:n},[(0,t.Wm)(g,{layer:l,"sequence-index":n,role:"button",tabindex:0,onDragstart:a[0]||(a[0]=(0,L.withModifiers)((()=>{}),["prevent"])),onClick:a=>e.onSelectLayerFrame(l,n)},null,8,["layer","sequence-index","onClick"])])))),128))])])),_:2},1024),(0,t.Wm)(d,{"aria-label":e.$t("app.layerList.editFrames"),class:"is-flex-grow-0 is-border-radius-attach-left px-2 py-0 mb-2"},{default:(0,t.w5)((()=>[B])),_:1},8,["aria-label"])])])):(0,t.kq)("v-if",!0),l.layers&&l.expanded&&0===l.layers.length?((0,t.wg)(),(0,t.j4)(y,{key:2,type:"info",title:e.$t("app.layerList.emptyGroup"),"show-icon":"",closable:!1,class:"is-justify-content-center"},null,8,["title"])):(0,t.kq)("v-if",!0),l.layers&&l.expanded&&l.layers.length>0?((0,t.wg)(),(0,t.j4)(m,{key:3,layers:l.layers,depth:e.depth+1},null,8,["layers","depth"])):(0,t.kq)("v-if",!0)],14,k)))),128)),null!=e.draggingLayerId?((0,t.wg)(),(0,t.iD)("li",{key:0,ref:"draggingLayer",class:"ogr-layer is-dragging","aria-hidden":"true",innerHTML:e.draggingItemHtml},null,8,M)):(0,t.kq)("v-if",!0)],2)),[[h,e.onPointerDragStartList,void 0,{dragstart:!0}],[h,e.onPointerDragEndList,void 0,{dragend:!0}],[h,e.onPointerPressList,void 0,{press:!0}],[h,e.onPointerMoveList,void 0,{move:!0,window:!0}],[h,e.onPointerUpList,void 0,{up:!0,window:!0}]])}]]);var se=l(22053),de=l(75930),ue=l(95452);(0,m.iH)("file");const ce=(0,t.aZ)({name:"DockSettings",directives:{loading:v.ZP.directive},components:{AppLayerList:oe,ElAlert:h.ZP,ElButton:b.ZP,ElScrollbar:f.default,ElTooltip:w.default},props:{isDialog:{type:Boolean,default:!1}},emits:["close","update:title"],setup(e,{emit:a}){a("update:title","dock.layers.title");const{layers:l}=(0,m.BK)(Y.default.state),i=(0,m.iH)(null),n=(0,m.iH)(0),r=(0,m.iH)(0),o=(0,m.iH)(!1);let s=document.createElement("div");const d=(0,t.Fl)((()=>Y.default.state.background.color.style)),u=(0,t.Fl)({get:()=>Y.default.state.background.visible,set(e){const a=Y.default.state.background;a.visible=e,Y.default.set("background",a),j.Z.set("dirty",!0)}});async function c(e){let a=Y.default.get("selectedLayerIds");0===a.length&&(a=[-1]);for(let l of a){const a=(0,Y.getLayerById)(l),t="group"===a?.type&&a?.expanded;await R.Z.dispatch("runAction",{action:new de.D({type:"Layer"===e?"empty":"group",groupId:t?l:a?.groupId,name:(0,Y.ensureUniqueLayerSiblingName)(t?a.layers[0]?.id:l,"New "+e)},a&&!t?"above":"top",a&&!t?l:void 0)})}}return(0,t.bv)((()=>{s=i.value.$el.querySelector(".el-scrollbar__wrap")})),{layers:l,scrollbar:i,scrollContainerHeight:n,scrollTop:r,tooltipShowDelay:se.Z.state.tooltipShowDelay,isBackgroundVisible:u,isHoveringBackground:o,backgroundStyle:d,onAddLayer:async function(){await c("Layer")},onAddGroup:async function(){await c("Group")},onChangeBackgroundColor:function(){ue.Z.emit("app.dialogs.openFromDock",{name:"color-picker",props:{color:Y.default.state.background.color},onClose:e=>{if(e?.color){const a=Y.default.state.background;a.color=e.color,Y.default.set("background",a),j.Z.set("dirty",!0)}}})},onScrollLayerList:function(){r.value=s.scrollTop,n.value=s.clientHeight},onScrollByAmount:function(e){let a=s.scrollTop+e;a<0&&(a=0),a>s.scrollHeight-s.clientHeight&&(a=s.scrollHeight-s.clientHeight),s.scrollTop=a,r.value=a}}}}),ge=(0,O.Z)(ce,[["render",function(e,a,l,m,h,b){const v=(0,t.up)("el-button"),f=(0,t.up)("app-layer-list"),w=(0,t.up)("el-alert"),L=(0,t.up)("el-scrollbar"),k=(0,t.Q2)("t");return(0,t.wg)(),(0,t.iD)(t.HY,null,[(0,t._)("div",n,[(0,t._)("div",r,[(0,t._)("strong",o,(0,i.toDisplayString)(e.$t("dock.layers.add"))+":",1),(0,t.Wm)(v,{type:"text",class:"px-0",onClick:e.onAddLayer},{default:(0,t.w5)((()=>[s,(0,t.Uk)(" "+(0,i.toDisplayString)(e.$t("dock.layers.layer")),1)])),_:1},8,["onClick"]),(0,t.Wm)(v,{type:"text",class:"px-0",onClick:e.onAddGroup},{default:(0,t.w5)((()=>[d,(0,t.Uk)(" "+(0,i.toDisplayString)(e.$t("dock.layers.group")),1)])),_:1},8,["onClick"])])]),(0,t._)("div",u,[(0,t.Wm)(L,{ref:"scrollbar",onScroll:e.onScrollLayerList},{default:(0,t.w5)((()=>[e.layers.length>0?((0,t.wg)(),(0,t.j4)(f,{key:0,layers:e.layers,"is-root":!0,"scroll-container-height":e.scrollContainerHeight,"scroll-top":e.scrollTop,onScrollBy:a[0]||(a[0]=a=>e.onScrollByAmount(a))},null,8,["layers","scroll-container-height","scroll-top"])):((0,t.wg)(),(0,t.j4)(w,{key:1,type:"info",title:e.$t("dock.layers.noLayers"),"show-icon":"",closable:!1,class:"is-justify-content-center"},null,8,["title"])),(0,t._)("ul",c,[(0,t._)("li",{class:(0,i.normalizeClass)(["ogr-layer is-background",{"is-dnd-hover":e.isHoveringBackground}])},[(0,t._)("span",g,[(0,t._)("span",{class:"ogr-layer-dnd-handle",onMouseenter:a[1]||(a[1]=a=>e.isHoveringBackground=!0),onMouseleave:a[2]||(a[2]=a=>e.isHoveringBackground=!1),onClick:a[3]||(a[3]=a=>e.onChangeBackgroundColor())},[(0,t._)("div",p,[(0,t._)("div",{class:"ogr-layer-thumbnail-custom-img",style:(0,i.normalizeStyle)({background:e.backgroundStyle})},null,4)]),(0,t.wy)((0,t._)("span",y,null,512),[[k,"dock.layers.background"]])],32),(0,t.Wm)(v,{type:"text",class:"px-2 mr-2","aria-label":e.$t("dock.layers.toggleBackgroundVisibility"),onClick:a[4]||(a[4]=a=>e.isBackgroundVisible=!e.isBackgroundVisible)},{default:(0,t.w5)((()=>[(0,t._)("i",{class:(0,i.normalizeClass)(["bi",{"bi-eye-fill":e.isBackgroundVisible,"bi-eye-slash":!e.isBackgroundVisible}]),"aria-hidden":"true"},null,2)])),_:1},8,["aria-label"])])],2)])])),_:1},8,["onScroll"])])],64)}]])}}]);