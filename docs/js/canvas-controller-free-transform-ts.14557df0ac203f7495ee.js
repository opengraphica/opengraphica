"use strict";(self.webpackChunkOpenGraphica=self.webpackChunkOpenGraphica||[]).push([[800],{56742:(t,e,a)=>{a.r(e),a.d(e,{default:()=>R});var s=a(66252),r=a(84510),n=a(84151),o=a(75710),i=a(91648),l=a(19971),h=a(8778),m=a(22053),f=a(67340),u=a(87521),c=a(72435),g=a(16081),d=a(57753),v=a(67091),S=a(32988),p=a(93249),D=a(85002),T=a(48050),w=a(84710),y=a(95452),b=a(75720),C=a(10177);class R extends r.default{remToPx=16;transformTranslateStart=null;transformStartDimensions={top:0,left:0,width:0,height:0,rotation:0,handleToRotationOrigin:0};transformStartLayerData=[];transformStartPickLayer=null;transformDragType=0;transformIsDragging=!1;transformIsRotating=!1;isPointerDragging=!1;actionQueue=new b.X;setBoundsDebounceHandle;selectedLayerIdsWatchStop=null;onEnter(){super.onEnter(),this.remToPx=parseFloat(getComputedStyle(document.documentElement).fontSize),n.eb.value=null,n.G$.value=!0,this.selectedLayerIdsWatchStop=(0,s.YP)((()=>f.default.state.selectedLayerIds),(t=>{const e=[];if(t.length>0)for(let a of t){const t=(0,f.getLayerById)(a);t&&!["group","empty"].includes(t.type)&&e.push(t)}n.NF.value=e,this.setBoundsFromSelectedLayers()}),{immediate:!0}),this.onCancelCurrentAction=this.onCancelCurrentAction.bind(this),this.onHistoryStep=this.onHistoryStep.bind(this),this.onStoreTransformStart=this.onStoreTransformStart.bind(this),this.onPreviewRotationChange=this.onPreviewRotationChange.bind(this),this.onPreviewDragResizeChange=this.onPreviewDragResizeChange.bind(this),this.onCommitTransforms=this.onCommitTransforms.bind(this),y.Z.on("editor.tool.cancelCurrentAction",this.onCancelCurrentAction),y.Z.on("editor.history.step",this.onHistoryStep),n.V$.on("storeTransformStart",this.onStoreTransformStart),n.V$.on("previewRotationChange",this.onPreviewRotationChange),n.V$.on("previewDragResizeChange",this.onPreviewDragResizeChange),n.V$.on("commitTransforms",this.onCommitTransforms),l.default.state.tutorialFlags.freeTransformToolIntroduction||(0,c.Vq)().then((()=>{let t='\n                    <p class="mb-3">This tool moves, resizes, and rotates layers. A boundary box shows around the selected layer(s).</p>\n                    <p class="mb-3">In <strong class="has-text-weight-bold">auto mode</strong>:</p>\n                ';(0,c.Q0)({flag:"freeTransformToolIntroduction",title:"Free Transform Tool",message:{touch:t+'\n                            <p class="mb-3"><strong class="has-text-weight-bold"><span class="bi bi-cursor"></span> Selection</strong> - Tap on a layer to select it.</p>\n                            <p class="mb-3"><strong class="has-text-weight-bold"><span class="bi bi-arrows-move"></span> Moving</strong> - Tap on a layer and drag to move it.</p>\n                            <p><strong class="has-text-weight-bold"><span class="bi bi-bounding-box"></span> Resizing</strong> - Use one finger to drag resize handles.</p>\n                        ',mouse:t+'\n                            <p class="mb-3"><strong class="has-text-weight-bold"><span class="bi bi-cursor"></span> Selection</strong> - <em>Left Click</em> on a layer to select it.</p>\n                            <p class="mb-3"><strong class="has-text-weight-bold"><span class="bi bi-arrows-move"></span> Moving</strong> - <em>Left Click</em> on a layer and drag to move it.</p>\n                            <p><strong class="has-text-weight-bold"><span class="bi bi-bounding-box"></span> Resizing</strong> - <em>Left Click</em> and drag resize handles.</p>\n                        '}})}))}onLeave(){this.selectedLayerIdsWatchStop&&(this.selectedLayerIdsWatchStop(),this.selectedLayerIdsWatchStop=null),y.Z.off("editor.tool.cancelCurrentAction",this.onCancelCurrentAction),y.Z.off("editor.history.step",this.onHistoryStep),n.V$.off("storeTransformStart",this.onStoreTransformStart),n.V$.off("previewRotationChange",this.onPreviewRotationChange),n.V$.off("previewDragResizeChange",this.onPreviewDragResizeChange),n.V$.off("commitTransforms",this.onCommitTransforms),l.default.state.tutorialFlags.freeTransformToolIntroduction||(0,c.Qs)("freeTransformToolIntroduction")}onMultiTouchDown(){super.onMultiTouchDown(),1===this.touches.length&&this.onTransformStart()}onPointerDown(t){super.onPointerDown(t),(0,w.u7)(t.target)||t.isPrimary&&["mouse","pen"].includes(t.pointerType)&&0===t.button&&this.onTransformStart()}onPointerMove(t){super.onPointerMove(t);const e=this.pointers.filter((e=>e.id===t.pointerId))[0];if(e&&t.isPrimary&&this.transformTranslateStart){const{viewTransformPoint:t}=this.getTransformedCursorInfo(),{shouldMaintainAspectRatio:a,shouldScaleDuringResize:s,shouldSnapRotationDegrees:r}=this.getTransformOptions();if(e.isDragging&&(this.isPointerDragging=!0),this.transformIsRotating){let e=Math.atan2(t.y-(n.we.value+n.Cb.value*n.OC.value),t.x-(n.t$.value+n.bf.value*n.bv.value))-this.transformStartDimensions.handleToRotationOrigin;if(r){const t=this.transformStartDimensions.rotation+e;e-=t-Math.round(t/(Math.PI/18))*(Math.PI/18)}this.previewRotationChange(this.transformStartDimensions.rotation+e)}else if(this.transformIsDragging){const e=0===this.transformDragType;let r=Math.floor(this.transformDragType/4)%2==1,o=Math.floor(this.transformDragType/8)%2==1,i=Math.floor(this.transformDragType/1)%2==1,l=Math.floor(this.transformDragType/2)%2==1;const h=Math.round(t.x-this.transformTranslateStart.x),m=Math.round(t.y-this.transformTranslateStart.y),f=Math.cos(n.Wn.value),u=Math.sin(n.Wn.value);let c=this.transformStartDimensions.width+f*h+u*m,g=this.transformStartDimensions.height+f*m-u*h;if(r&&(c=this.transformStartDimensions.width-(f*h+u*m)),i&&(g=this.transformStartDimensions.height-(f*m-u*h)),a&&r+o+i+l>1){const t=g*(this.transformStartDimensions.width/this.transformStartDimensions.height),e=c*(this.transformStartDimensions.height/this.transformStartDimensions.width);g>e?c=t:g=e}let d=this.transformStartDimensions.left,v=this.transformStartDimensions.top,S=this.transformStartDimensions.width,p=this.transformStartDimensions.height;if(e&&(v=this.transformStartDimensions.top+m,d=this.transformStartDimensions.left+h),(i||r)&&(d=this.transformStartDimensions.left,v=this.transformStartDimensions.top),i){const t=Math.max(1-this.transformStartDimensions.height,g-this.transformStartDimensions.height);d-=-u*t,v-=f*t}if(r){const t=Math.max(1-this.transformStartDimensions.width,c-this.transformStartDimensions.width);d-=f*t,v-=u*t}(r||o)&&(S=c),(i||l)&&(p=g),S<=1&&(S=1),p<=1&&(p=1),this.previewDragResizeChange({top:v,left:d,width:S,height:p},s)}i.Z.set("dirty",!0)}if(!this.transformTranslateStart&&t.isPrimary&&["mouse","pen"].includes(t.pointerType)){const{transformBoundsPoint:t,viewDecomposedTransform:e}=this.getTransformedCursorInfo();if(this.isPointOnRotateHandle(t,e))n.Gd.value=!0,n.G0.value=null;else{n.Gd.value=!1;let a=this.getTransformDragType(t,e);n.G0.value=null!=a?a:null}}}async onPointerUp(t){super.onPointerUp(t),t.isPrimary&&this.onTransformEnd()}async onTransformStart(){this.actionQueue.push((async()=>{this.isPointerDragging=!1;let{transformBoundsPoint:t,viewTransformPoint:e,viewDecomposedTransform:a}=this.getTransformedCursorInfo();if((o.R_.value||o.Kk.value)&&(n.NF.value.length>0?(n.Bb.value,await h.Z.dispatch("runAction",{action:new g.R({clearSelection:!0,selectNewLayers:"replace"})})):await h.Z.dispatch("runAction",{action:new d.m})),this.determineDragRotateType(e,t,a),"auto"===n.Bb.value&&(this.transformStartPickLayer=this.pickLayer(e)),!this.transformTranslateStart&&"auto"===n.Bb.value){const r=this.transformStartPickLayer;this.transformStartPickLayer=null,null!=r&&r!=f.default.get("selectedLayerIds")[0]&&(await h.Z.dispatch("runAction",{action:new v.h([r])}),await(0,s.Y3)(),this.setBoundsFromSelectedLayersImmediate(),this.determineDragRotateType(e,t,a))}this.transformTranslateStart&&(m.Z.set("useCanvasViewport",!0),i.Z.set("useCssViewport",!1),i.Z.set("viewDirty",!0))}))}async onTransformEnd(){this.actionQueue.push((async()=>{if(this.transformTranslateStart){try{await this.commitTransforms()}catch(t){}m.Z.get("preferCanvasViewport")||(m.Z.set("useCanvasViewport",!1),i.Z.set("useCssViewport",!0));try{if(null!=this.transformStartPickLayer&&!this.isPointerDragging){const t=this.transformStartPickLayer;t!=f.default.get("selectedLayerIds")[0]&&await h.Z.dispatch("runAction",{action:new v.h([t])})}}catch(t){}this.transformStartPickLayer=null}n.G0.value=null}))}onCancelCurrentAction(){this.transformStartDimensions&&(this.transformIsRotating&&this.previewRotationChange(this.transformStartDimensions.rotation),this.transformIsDragging&&this.previewDragResizeChange(this.transformStartDimensions),this.transformTranslateStart=null,this.transformIsRotating=!1,this.transformIsDragging=!1,i.Z.set("dirty",!0))}onHistoryStep(t){"do"!=t?.trigger&&(n.G$.value=!0,this.setBoundsFromSelectedLayers())}onStoreTransformStart(t){this.storeTransformStart(t?.viewTransformPoint)}onPreviewRotationChange(t){t&&(this.previewRotationChange(t.rotation),i.Z.set("dirty",!0))}onPreviewDragResizeChange(t){t&&(this.previewDragResizeChange(t.transform,t.shouldScaleDuringResize),i.Z.set("dirty",!0))}onCommitTransforms(t){this.commitTransforms()}storeTransformStart(t){t||(t=this.getTransformedCursorInfo().viewTransformPoint),this.transformTranslateStart=t,this.transformStartDimensions={top:n.we.value,left:n.t$.value,width:n.bf.value,height:n.Cb.value,rotation:n.Wn.value,handleToRotationOrigin:0},this.transformStartLayerData=[];for(let t of n.NF.value)this.transformStartLayerData.push({transform:t.transform})}determineDragRotateType(t,e,a){if(this.storeTransformStart(t),this.transformIsRotating=!1,this.transformIsDragging=!1,this.isPointOnRotateHandle(e,a))this.transformIsRotating=!0,n.Gd.value=!0,this.transformStartDimensions.handleToRotationOrigin=Math.atan2(t.y-(n.we.value+n.Cb.value*n.OC.value),t.x-(n.t$.value+n.bf.value*n.bv.value)),this.transformDragType=0,n.G0.value=null;else{n.Gd.value=!1;let t=this.getTransformDragType(e,a);null!=t?this.transformDragType=t:"current"===n.Bb.value?this.transformDragType=0:this.transformTranslateStart=null,null!=!t&&(this.transformIsDragging=!0),n.G0.value=t}}previewRotationChange(t){const e=t-this.transformStartDimensions.rotation;n.V$.emit("setDimensions",{rotation:t,transformOriginX:n.bv.value,transformOriginY:n.OC.value});for(const[t,a]of n.NF.value.entries()){const s=n.t$.value+n.bv.value*n.bf.value,r=n.we.value+n.OC.value*n.Cb.value,o=new DOMPoint(s,r).matrixTransform(this.transformStartLayerData[t].transform.inverse()),i=(0,u.cV)(this.transformStartLayerData[t].transform),l=DOMMatrix.fromMatrix(this.transformStartLayerData[t].transform).translateSelf(o.x,o.y).scaleSelf(1/i.scaleX,1/i.scaleY).rotateSelf(e*Math.RADIANS_TO_DEGREES).scaleSelf(i.scaleX,i.scaleY).translateSelf(-o.x,-o.y);a.transform=l}}previewDragResizeChange(t,e){null==e&&(e=this.getTransformOptions().shouldScaleDuringResize);let a=this.transformStartDimensions.width*n.bv.value,s=this.transformStartDimensions.height*n.OC.value;const r=(0,u.cV)((new DOMMatrix).translateSelf(-a,-s).translateSelf(t.left,t.top).rotateSelf(n.Wn.value*Math.RADIANS_TO_DEGREES).translateSelf(a,s));a=t.width*n.bv.value,s=t.height*n.OC.value;const o=(0,u.cV)((new DOMMatrix).translateSelf(-a,-s).translateSelf(t.left,t.top).rotateSelf(n.Wn.value*Math.RADIANS_TO_DEGREES).translateSelf(a,s));n.V$.emit("setDimensions",{left:t.left+o.translateX-r.translateX,top:t.top+o.translateY-r.translateY,width:t.width,height:t.height});for(const[a,s]of n.NF.value.entries()){const r=(0,u.cV)(this.transformStartLayerData[a].transform);let n=DOMMatrix.fromMatrix(this.transformStartLayerData[a].transform);e&&n.scaleSelf(1/r.scaleX,1/r.scaleY),n.rotateSelf(-r.rotation*Math.RADIANS_TO_DEGREES).translateSelf(t.left-this.transformStartDimensions.left,t.top-this.transformStartDimensions.top).rotateSelf(r.rotation*Math.RADIANS_TO_DEGREES),e&&n.scaleSelf(r.scaleX*t.width/this.transformStartDimensions.width,r.scaleY*t.height/this.transformStartDimensions.height),s.transform=n}}async commitTransforms(){try{let{shouldScaleDuringResize:t}=this.getTransformOptions();n.bf.value=Math.max(1,n.bf.value),n.Cb.value=Math.max(1,n.Cb.value),n.Pt.value=[],n.dD.value=[];const e=n.t$.value!=this.transformStartDimensions.left||n.we.value!=this.transformStartDimensions.top,a=n.bf.value!=this.transformStartDimensions.width||n.Cb.value!=this.transformStartDimensions.height,s=n.Wn.value!=this.transformStartDimensions.rotation;if(e||a||s){const r=[];for(const[e,a]of n.NF.value.entries())r.push(new S.E({id:a.id,transform:a.transform,...t?{}:{width:n.bf.value,height:n.Cb.value}},{transform:this.transformStartLayerData[e].transform}));await h.Z.dispatch("runAction",{action:new p.x("freeTransform",[...s?["action.freeTransformRotate"]:[],...a?["action.freeTransformScale"]:[],...e?["action.freeTransformTranslate"]:[]][0],r)})}}catch(t){console.error(t)}this.transformTranslateStart=null,this.transformStartLayerData=[],this.transformStartDimensions={top:0,left:0,width:0,height:0,rotation:0,handleToRotationOrigin:0},this.transformIsRotating=!1,this.transformIsDragging=!1}getTransformedCursorInfo(){const t=window.devicePixelRatio||1,e=i.Z.get("transform"),a=i.Z.get("decomposedTransform"),s=new DOMPoint(this.lastCursorX*t,this.lastCursorY*t).matrixTransform(e.inverse()),r=n.t$.value+n.bv.value*n.bf.value,o=n.we.value+n.OC.value*n.Cb.value,l=(new DOMMatrix).translateSelf(r,o).rotateSelf(n.Wn.value*Math.RADIANS_TO_DEGREES).translateSelf(-r,-o);return{viewTransformPoint:s,transformBoundsPoint:new DOMPoint(this.lastCursorX*t,this.lastCursorY*t).matrixTransform(e.inverse()).matrixTransform(l.inverse()),viewDecomposedTransform:a}}pickLayer(t){const e=document.createElement("canvas");e.width=1,e.height=1;const a=e.getContext("2d");if(!a)return null;const s=(new DOMMatrix).translateSelf(-t.x,-t.y),r={point:new DOMPoint,resultId:void 0,resultPixelTest:void 0};return(0,D.j)(e,a,{initialTransform:s,selectionTest:r}),null!=r.resultId?r.resultId:null}isPointOnRotateHandle(t,e){const a=window.devicePixelRatio||1;this.remToPx=parseFloat(getComputedStyle(document.documentElement).fontSize);const s=2*this.remToPx/e.scaleX*a,r=2*this.remToPx/e.scaleX*a/2;return t.x>n.t$.value+n.bf.value/2-r&&t.x<n.t$.value+n.bf.value/2+r&&t.y>n.we.value-s-r&&t.y<n.we.value-s+r}getTransformDragType(t,e){const a=window.devicePixelRatio||1;let s=0;this.remToPx=parseFloat(getComputedStyle(document.documentElement).fontSize);const r=.75*this.remToPx/e.scaleX*a+2,o=this.touches.length>0?r/2:0,i=o,l=o;return t.y>=n.we.value-r-o&&t.y<=n.we.value+i&&(s|=1),t.y>=n.we.value+n.Cb.value-i&&t.y<=n.we.value+n.Cb.value+r+o&&(s|=2),t.x>=n.t$.value-r-o&&t.x<=n.t$.value+l&&(s|=4),t.x>=n.t$.value+n.bf.value-l&&t.x<=n.t$.value+n.bf.value+r+o&&(s|=8),(t.x<n.t$.value-r-o||t.x>n.t$.value+n.bf.value+r+o||t.y<n.we.value-r-o||t.y>n.we.value+n.Cb.value+r+o)&&(s=null),s}setBoundsFromSelectedLayers(){clearTimeout(this.setBoundsDebounceHandle);const t=window.setTimeout((async()=>{await(0,s.Y3)(),t===this.setBoundsDebounceHandle&&this.setBoundsFromSelectedLayersImmediate()}),100);this.setBoundsDebounceHandle=t}setBoundsFromSelectedLayersImmediate(){n.G$.value=!1;const t=o.R_.value||o.Kk.value;if(t){const e=t===o.R_.value?o.ot.value:o.pt.value,a=(0,T._7)((0,T.p7)(t));n.V$.emit("setDimensions",{left:e.x+a.left,top:e.y+a.top,width:a.right-a.left,height:a.bottom-a.top,rotation:0})}else if(1===n.NF.value.length){const t=n.NF.value[0],e=t.width*n.bv.value,a=t.height*n.OC.value,s=(0,u.cV)(t.transform),r=(0,u.cV)(DOMMatrix.fromMatrix(t.transform).translateSelf(e,a).scaleSelf(1/s.scaleX,1/s.scaleY).rotateSelf(-s.rotation*Math.RADIANS_TO_DEGREES).scaleSelf(s.scaleX,s.scaleY).translateSelf(-e,-a));n.V$.emit("setDimensions",{left:r.translateX,top:r.translateY,width:t.width*s.scaleX,height:t.height*s.scaleY,rotation:s.rotation})}}getTransformOptions(){let t=!0,e=!0,a=n.Jk.value;return!0===C.G5.value&&(t=!1,a=!n.Jk.value),1===n.NF.value.length&&"text"===n.NF.value[0].type&&(t=!1,e=!1),{shouldMaintainAspectRatio:t,shouldScaleDuringResize:e,shouldSnapRotationDegrees:a}}}}}]);